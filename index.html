<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple To-Do App (Real-Time)</title>
    <!-- Load Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configure Tailwind for custom styles, especially using the Inter font -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'primary': '#4f46e5',
                        'secondary': '#6366f1',
                        'bg-main': '#f9fafb',
                    }
                }
            }
        }
    </script>
    <style>
        /* Define the Inter font for better readability */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        
        /* Basic styles for the list container */
        .task-item {
            transition: all 0.3s ease;
        }

        .task-item.completed {
            background-color: #f3f4f6;
            color: #9ca3af;
            text-decoration: line-through;
        }
        
        /* Custom scrollbar styling for the task list */
        #taskList {
            max-height: 400px;
            overflow-y: auto;
        }
        #taskList::-webkit-scrollbar {
            width: 8px;
        }
        #taskList::-webkit-scrollbar-thumb {
            background-color: #d1d5db;
            border-radius: 4px;
        }
    </style>
</head>
<body class="bg-bg-main min-h-screen flex items-center justify-center p-4 font-sans">

    <!-- Main Application Container -->
    <div class="w-full max-w-md bg-white shadow-2xl rounded-xl p-6 md:p-8">
        
        <h1 class="text-3xl font-extrabold text-gray-900 mb-2 text-center">
            ðŸš€ My Vercel/Render To-Do
        </h1>
        <p id="authStatus" class="text-xs text-primary mb-6 text-center">Loading authentication...</p>
        
        <!-- Input Form for New Tasks -->
        <div class="flex space-x-2 mb-8">
            <input 
                type="text" 
                id="taskInput" 
                placeholder="What needs to be done?"
                class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-secondary focus:border-secondary transition duration-150"
                maxlength="100"
            >
            <button 
                id="addButton"
                onclick="addTask()"
                class="bg-primary hover:bg-secondary text-white font-semibold py-3 px-4 rounded-lg shadow-md transition duration-200 disabled:opacity-50"
                disabled
            >
                Add
            </button>
        </div>

        <!-- Task List Container -->
        <div id="taskList" class="space-y-3">
            <!-- Tasks will be rendered here by JavaScript -->
            <p class="text-gray-500 text-center py-4" id="loadingMessage">
                Loading tasks...
            </p>
        </div>
        
    </div>

    <!-- Firebase Configuration and Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            query, 
            onSnapshot, 
            addDoc, 
            updateDoc, 
            deleteDoc,
            doc,
            setLogLevel
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- GLOBAL FIREBASE/AUTH/APP ID VARIABLES (MANDATORY) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        // In-memory array to hold tasks when database connection is unavailable (Mock Mode)
        let mockTasks = []; 

        let firebaseConfig;
        try {
            // Attempt to parse the injected config
            const injectedConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
            
            // Check if the provided configuration is empty. If so, use a harmless mock config 
            // to prevent the application from crashing on initialization.
            if (Object.keys(injectedConfig).length === 0) {
                console.warn("Using mock Firebase configuration as injected config is empty. Database functions will fail.");
                firebaseConfig = { 
                    apiKey: "dummy-key", 
                    authDomain: "dummy.firebaseapp.com", 
                    projectId: "dummy-project" 
                };
            } else {
                firebaseConfig = injectedConfig;
            }
        } catch (e) {
            console.error("Failed to parse __firebase_config. Using mock config.", e);
            firebaseConfig = { 
                apiKey: "dummy-key", 
                authDomain: "dummy.firebaseapp.com", 
                projectId: "dummy-project" 
            };
        }
        
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth;
        let userId = null;
        let isAuthReady = false;

        setLogLevel('Debug'); // Enable Firestore logging

        // --- 1. FIREBASE INITIALIZATION AND AUTHENTICATION ---
        try {
            // This will now use either the real config or the mock config
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            // Check if we are in mock mode immediately after config determination
            const isMockMode = firebaseConfig.apiKey === 'dummy-key'; 

            // Authentication Listener
            onAuthStateChanged(auth, async (user) => {
                const authStatusEl = document.getElementById('authStatus');
                const addButton = document.getElementById('addButton');

                if (user) {
                    // Success with real user (or anonymous user)
                    userId = user.uid;
                    authStatusEl.innerHTML = `Signed in. User ID: <span class="font-mono text-xs break-all">${userId}</span>`;
                    addButton.disabled = false;
                    isAuthReady = true;
                    // Start listening to tasks only after successful sign-in
                    setupRealtimeListener(); 
                } else {
                    if (isMockMode) {
                        // Handle Mock Mode: bypass real auth, set dummy ID, enable button.
                        userId = 'mock-user-' + Math.random().toString(36).substring(2, 9);
                        authStatusEl.innerHTML = `<span class="text-red-500 font-bold">Signed in (MOCK MODE)</span>. User ID: <span class="font-mono text-xs break-all">${userId}</span>`;
                        
                        addButton.disabled = false;
                        isAuthReady = true;
                        
                        setupRealtimeListener(); // This will trigger the Mock Mode logic inside
                        return; // Exit listener
                    }
                    
                    // Handle Real Auth Attempt
                    try {
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            // Fallback to anonymous sign-in if no custom token is available
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.error("Authentication error:", error);
                        // Provide more helpful message on authentication failure
                        authStatusEl.textContent = "Authentication Failed. Ensure Firebase Auth is enabled and credentials are valid.";
                        addButton.disabled = true;
                    }
                }
            });

        } catch (error) {
            console.error("Firebase Initialization Error:", error);
            document.getElementById('authStatus').textContent = "Firebase initialization failed. Check config.";
        }


        // --- 2. FIRESTORE COLLECTION REFERENCE HELPER ---

        /**
         * Generates the collection reference for the user's private todo list.
         */
        function getTodoCollectionRef() {
            if (!db || !userId) {
                console.error("Firestore or User ID is not available in real mode.");
                return null;
            }
            // Private data path: /artifacts/{appId}/users/{userId}/todos
            const collectionPath = `artifacts/${appId}/users/${userId}/todos`;
            return collection(db, collectionPath);
        }

        // --- 3. CRUD OPERATIONS ---

        window.addTask = async function() {
            const taskInput = document.getElementById('taskInput');
            const description = taskInput.value.trim();

            if (!description) return;
            if (!isAuthReady) {
                console.warn("Auth not ready, cannot add task.");
                return;
            }
            
            // Handle Mock Mode: Update local array and re-render
            if (firebaseConfig.apiKey === 'dummy-key') {
                const newTask = {
                    id: 'mock-' + Date.now(),
                    description: description,
                    completed: false,
                    createdAt: Date.now()
                };
                mockTasks.push(newTask);
                taskInput.value = '';
                // Client-side sorting before rendering
                mockTasks.sort((a, b) => b.createdAt - a.createdAt);
                renderTasks(mockTasks); 
                return;
            }


            const todoRef = getTodoCollectionRef();
            if (!todoRef) {
                 console.error("Cannot add task: Database reference is unavailable.");
                 return;
            }

            try {
                await addDoc(todoRef, {
                    description: description,
                    completed: false,
                    createdAt: Date.now()
                });
                taskInput.value = ''; // Clear input on success
            } catch (e) {
                console.error("Error adding document: ", e);
                // In a real app, show a friendly error message here
            }
        };

        window.toggleTask = async function(docId, currentStatus) {
            if (!isAuthReady) {
                console.warn("Auth not ready, cannot toggle task.");
                return;
            }
            
            // Handle Mock Mode: Update local array and re-render
            if (firebaseConfig.apiKey === 'dummy-key') {
                const task = mockTasks.find(t => t.id === docId);
                if (task) {
                    task.completed = !currentStatus;
                    renderTasks(mockTasks); 
                }
                return;
            }

            const todoRef = getTodoCollectionRef();
            if (!todoRef) {
                 console.error("Cannot toggle task: Database reference is unavailable.");
                 return;
            }

            try {
                const taskDocRef = doc(todoRef, docId);
                await updateDoc(taskDocRef, {
                    completed: !currentStatus
                });
            } catch (e) {
                console.error("Error toggling document: ", e);
            }
        };

        window.deleteTask = async function(docId) {
            if (!isAuthReady) {
                console.warn("Auth not ready, cannot delete task.");
                return;
            }
            
            // Handle Mock Mode: Update local array and re-render
            if (firebaseConfig.apiKey === 'dummy-key') {
                mockTasks = mockTasks.filter(t => t.id !== docId);
                renderTasks(mockTasks);
                return;
            }

            const todoRef = getTodoCollectionRef();
            if (!todoRef) {
                 console.error("Cannot delete task: Database reference is unavailable.");
                 return;
            }

            try {
                const taskDocRef = doc(todoRef, docId);
                await deleteDoc(taskDocRef);
            } catch (e) {
                console.error("Error deleting document: ", e);
            }
        };


        // --- 4. REAL-TIME LISTENER & RENDERING ---

        function setupRealtimeListener() {
            const isMockMode = firebaseConfig.apiKey === 'dummy-key'; 
            const loadingMessageEl = document.getElementById('loadingMessage');

            if (isMockMode) {
                loadingMessageEl.textContent = "Running in MOCK MODE (In-Memory). Data will NOT save to the database.";
                renderTasks(mockTasks); // Initial render using the empty mock array
                return;
            }
            
            const todoRef = getTodoCollectionRef();
            if (!todoRef) return;
            
            // Note: We avoid using orderBy() and will sort client-side to prevent index issues.
            const q = query(todoRef); 

            // onSnapshot sets up the real-time listener
            onSnapshot(q, (snapshot) => {
                const tasks = [];
                snapshot.forEach((doc) => {
                    tasks.push({ id: doc.id, ...doc.data() });
                });

                // Client-side sorting by creation date (newest first)
                tasks.sort((a, b) => b.createdAt - a.createdAt);
                
                renderTasks(tasks);
            }, (error) => {
                console.error("Error listening to collection: ", error);
                // If the listener fails (likely due to invalid credentials)
                document.getElementById('loadingMessage').textContent = "Database connection offline. Tasks cannot be loaded or saved.";
            });
        }

        /**
         * Renders the list of tasks to the DOM.
         */
        function renderTasks(tasks) {
            const taskListEl = document.getElementById('taskList');
            taskListEl.innerHTML = ''; // Clear existing list

            if (tasks.length === 0) {
                taskListEl.innerHTML = `<p class="text-gray-500 text-center py-4">You're all done! Add a new task above.</p>`;
                return;
            }

            tasks.forEach(task => {
                const isCompleted = task.completed;
                
                const taskItem = document.createElement('div');
                taskItem.id = `task-${task.id}`;
                
                const statusClass = isCompleted ? 'completed' : 'bg-white hover:shadow-lg';
                const descriptionClass = isCompleted ? 'text-gray-500' : 'text-gray-800';

                // Tailwind Classes for responsive, styled list items
                taskItem.className = `task-item flex items-center justify-between p-4 rounded-xl shadow-md transition-all duration-300 ${statusClass} border border-gray-200`;

                taskItem.innerHTML = `
                    <div class="flex items-center flex-grow min-w-0">
                        <!-- Checkbox -->
                        <input 
                            type="checkbox" 
                            id="check-${task.id}" 
                            ${isCompleted ? 'checked' : ''}
                            onclick="window.toggleTask('${task.id}', ${isCompleted})"
                            class="h-5 w-5 text-primary bg-gray-100 border-gray-300 rounded focus:ring-secondary cursor-pointer flex-shrink-0"
                        >
                        <!-- Task Description -->
                        <label for="check-${task.id}" class="ml-4 text-lg font-medium select-none cursor-pointer truncate ${descriptionClass}">
                            ${task.description}
                        </label>
                    </div>
                    
                    <!-- Delete Button -->
                    <button 
                        onclick="window.deleteTask('${task.id}')"
                        class="ml-4 p-2 text-gray-400 hover:text-red-600 rounded-full transition duration-150 flex-shrink-0"
                        aria-label="Delete task"
                    >
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                    </button>
                `;
                taskListEl.appendChild(taskItem);
            });
        }
    </script>
</body>
</html>
