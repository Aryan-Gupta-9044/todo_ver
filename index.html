<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple To-Do App (Real-Time)</title>
    <!-- Load Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configure Tailwind for custom styles, especially using the Inter font -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'primary': '#4f46e5',
                        'secondary': '#6366f1',
                        'bg-main': '#f9fafb',
                    }
                }
            }
        }
    </script>
    <style>
        /* Define the Inter font for better readability */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        
        /* Basic styles for the list container */
        .task-item {
            transition: all 0.3s ease;
        }

        .task-item.completed {
            background-color: #f3f4f6;
            color: #9ca3af;
            text-decoration: line-through;
        }
        
        /* Custom scrollbar styling for the task list */
        #taskList {
            max-height: 400px;
            overflow-y: auto;
        }
        #taskList::-webkit-scrollbar {
            width: 8px;
        }
        #taskList::-webkit-scrollbar-thumb {
            background-color: #d1d5db;
            border-radius: 4px;
        }
    </style>
</head>
<body class="bg-bg-main min-h-screen flex items-center justify-center p-4 font-sans">

    <!-- Main Application Container -->
    <div class="w-full max-w-md bg-white shadow-2xl rounded-xl p-6 md:p-8">
        
        <h1 class="text-3xl font-extrabold text-gray-900 mb-2 text-center">
            ðŸš€ My Vercel/Render To-Do
        </h1>
        
        <!-- === AUTHENTICATION CONTAINER === -->
        <div id="authContainer" class="space-y-4">
            <p class="text-sm text-center text-gray-600 mb-4">Log in or register to save your list.</p>

            <input 
                type="email" 
                id="authEmail" 
                placeholder="Email Address"
                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-secondary focus:border-secondary transition duration-150"
            >
            <input 
                type="password" 
                id="authPassword" 
                placeholder="Password"
                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-secondary focus:border-secondary transition duration-150"
            >

            <div class="flex space-x-2">
                <button 
                    id="loginButton"
                    onclick="loginUser()"
                    class="w-1/2 bg-primary hover:bg-secondary text-white font-semibold py-3 px-4 rounded-lg shadow-md transition duration-200"
                >
                    Log In
                </button>
                <button 
                    id="registerButton"
                    onclick="registerUser()"
                    class="w-1/2 bg-gray-500 hover:bg-gray-600 text-white font-semibold py-3 px-4 rounded-lg shadow-md transition duration-200"
                >
                    Register
                </button>
            </div>
            
            <p id="authError" class="text-sm text-center text-red-500 pt-2"></p>
        </div>

        <!-- === TO-DO LIST CONTAINER === -->
        <div id="todoContainer" class="hidden">
            
            <!-- Auth Status and Logout Button -->
            <div class="flex justify-between items-center mb-6 border-b pb-4 border-gray-100">
                <p id="authStatus" class="text-xs font-medium text-gray-700">Signed in.</p>
                <button 
                    onclick="logoutUser()" 
                    class="text-sm text-gray-500 hover:text-red-500 font-medium transition duration-150 p-2 rounded-lg"
                >
                    Logout
                </button>
            </div>

            <!-- Input Form for New Tasks -->
            <div class="flex space-x-2 mb-8">
                <input 
                    type="text" 
                    id="taskInput" 
                    placeholder="What needs to be done?"
                    class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-secondary focus:border-secondary transition duration-150"
                    maxlength="100"
                >
                <button 
                    id="addButton"
                    onclick="addTask()"
                    class="bg-primary hover:bg-secondary text-white font-semibold py-3 px-4 rounded-lg shadow-md transition duration-200 disabled:opacity-50"
                >
                    Add
                </button>
            </div>

            <!-- Task List Container -->
            <div id="taskList" class="space-y-3">
                <!-- Tasks will be rendered here by JavaScript -->
                <p class="text-gray-500 text-center py-4" id="loadingMessage">
                    Loading tasks...
                </p>
            </div>
        </div>
        
    </div>

    <!-- Firebase Configuration and Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInWithCustomToken, 
            onAuthStateChanged, 
            signOut,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            query, 
            onSnapshot, 
            addDoc, 
            updateDoc, 
            deleteDoc,
            doc,
            setLogLevel
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- GLOBAL FIREBASE/AUTH/APP ID VARIABLES (MANDATORY) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        let firebaseConfig;
        let isOfflineMode = false;

        try {
            const injectedConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
            
            if (Object.keys(injectedConfig).length === 0 || !injectedConfig.projectId || injectedConfig.projectId === 'dummy-project') {
                isOfflineMode = true;
                console.warn("Firebase configuration is missing or invalid. Running in OFFLINE UI Mode.");
                firebaseConfig = { apiKey: "dummy-key", authDomain: "dummy.firebaseapp.com", projectId: "dummy-project" };
            } else {
                firebaseConfig = injectedConfig;
            }
        } catch (e) {
            console.error("Failed to parse __firebase_config. Switching to OFFLINE UI Mode.", e);
            isOfflineMode = true;
            firebaseConfig = { apiKey: "dummy-key", authDomain: "dummy.firebaseapp.com", projectId: "dummy-project" };
        }
        
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth;
        let userId = null;
        let isAuthReady = false;

        setLogLevel('Debug'); // Enable Firestore logging

        // --- Helper for UI State Management ---
        function setUIState(isAuthenticated, userEmail = null) {
            const authContainer = document.getElementById('authContainer');
            const todoContainer = document.getElementById('todoContainer');
            const statusEl = document.getElementById('authStatus');
            const authErrorEl = document.getElementById('authError');
            
            authErrorEl.textContent = ''; // Clear previous errors

            if (isAuthenticated) {
                authContainer.classList.add('hidden');
                todoContainer.classList.remove('hidden');
                statusEl.textContent = `Signed in as: ${userEmail || 'User'}`;
            } else {
                todoContainer.classList.add('hidden');
                authContainer.classList.remove('hidden');
                statusEl.textContent = ''; // Cleared on auth page
                
                if (isOfflineMode) {
                     authErrorEl.textContent = "Authentication is OFFLINE. Cannot log in or save data.";
                }
            }
        }

        // --- Authentication Functions ---
        window.registerUser = async function() {
            if (isOfflineMode) return document.getElementById('authError').textContent = "Cannot register: Firebase is offline.";
            
            const email = document.getElementById('authEmail').value.trim();
            const password = document.getElementById('authPassword').value.trim();
            const errorEl = document.getElementById('authError');
            errorEl.textContent = '';

            try {
                await createUserWithEmailAndPassword(auth, email, password);
                // Auth listener handles the state change on successful registration
            } catch (error) {
                console.error("Registration error:", error);
                errorEl.textContent = error.message.includes('weak-password') ? "Password must be at least 6 characters." : error.message;
            }
        };

        window.loginUser = async function() {
            if (isOfflineMode) return document.getElementById('authError').textContent = "Cannot log in: Firebase is offline.";

            const email = document.getElementById('authEmail').value.trim();
            const password = document.getElementById('authPassword').value.trim();
            const errorEl = document.getElementById('authError');
            errorEl.textContent = '';

            try {
                await signInWithEmailAndPassword(auth, email, password);
                // Auth listener handles the state change on successful login
            } catch (error) {
                console.error("Login error:", error);
                errorEl.textContent = "Login failed. Check email and password.";
            }
        };

        window.logoutUser = async function() {
            if (isOfflineMode) {
                // If offline, just reset UI state as if logged out, although no real auth occurred.
                userId = null;
                isAuthReady = false;
                setUIState(false);
                document.getElementById('taskInput').value = '';
                document.getElementById('taskList').innerHTML = `<p class="text-gray-500 text-center py-4">Please log in to see your list.</p>`;
                return;
            }
            
            try {
                await signOut(auth);
                // Auth listener handles the state change
            } catch (error) {
                console.error("Logout error:", error);
            }
        };

        // --- 1. FIREBASE INITIALIZATION AND AUTHENTICATION ---
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            // Authentication Listener
            onAuthStateChanged(auth, async (user) => {
                isAuthReady = true;

                if (user) {
                    // Logged In
                    userId = user.uid;
                    setUIState(true, user.email);
                    setupRealtimeListener(); 
                } else {
                    // Logged Out or Initial Load
                    userId = null;
                    document.getElementById('authEmail').value = '';
                    document.getElementById('authPassword').value = '';
                    
                    if (initialAuthToken && !isOfflineMode) {
                        // Attempt silent sign-in with custom token if available
                         try {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } catch (error) {
                            // If custom token fails, show login form
                            console.error("Custom token sign-in failed:", error);
                            setUIState(false);
                        }
                    } else {
                         // If no user, no token, or offline mode, show login form
                         setUIState(false);
                    }
                }
            });

        } catch (error) {
            console.error("Firebase Initialization Error:", error);
            document.getElementById('authError').textContent = "Initialization failed. Check console for config errors.";
            setUIState(false); // Ensure Auth UI is shown on failure
        }


        // --- 2. FIRESTORE COLLECTION REFERENCE HELPER ---

        function getTodoCollectionRef() {
            if (!db || !userId) {
                console.error("Firestore or User ID is not available.");
                return null;
            }
            const collectionPath = `artifacts/${appId}/users/${userId}/todos`;
            return collection(db, collectionPath);
        }

        // --- 3. CRUD OPERATIONS ---

        window.addTask = async function() {
            if (!isAuthReady || isOfflineMode || !userId) return;

            const taskInput = document.getElementById('taskInput');
            const description = taskInput.value.trim();

            if (!description) return;

            const todoRef = getTodoCollectionRef();
            if (!todoRef) {
                 console.error("Cannot add task: Database reference is unavailable.");
                 return;
            }

            try {
                await addDoc(todoRef, {
                    description: description,
                    completed: false,
                    createdAt: Date.now()
                });
                taskInput.value = ''; 
            } catch (e) {
                console.error("Error adding document: ", e);
            }
        };

        window.toggleTask = async function(docId, currentStatus) {
            if (!isAuthReady || isOfflineMode || !userId) return;

            const todoRef = getTodoCollectionRef();
            if (!todoRef) {
                 console.error("Cannot toggle task: Database reference is unavailable.");
                 return;
            }

            try {
                const taskDocRef = doc(todoRef, docId);
                await updateDoc(taskDocRef, {
                    completed: !currentStatus
                });
            } catch (e) {
                console.error("Error toggling document: ", e);
            }
        };

        window.deleteTask = async function(docId) {
            if (!isAuthReady || isOfflineMode || !userId) return;

            const todoRef = getTodoCollectionRef();
            if (!todoRef) {
                 console.error("Cannot delete task: Database reference is unavailable.");
                 return;
            }

            try {
                const taskDocRef = doc(todoRef, docId);
                await deleteDoc(taskDocRef);
            } catch (e) {
                console.error("Error deleting document: ", e);
            }
        };


        // --- 4. REAL-TIME LISTENER & RENDERING ---

        function setupRealtimeListener() {
            if (isOfflineMode) {
                document.getElementById('loadingMessage').textContent = "Database connection is OFFLINE. Please check Firebase configuration.";
                return;
            }

            const todoRef = getTodoCollectionRef();
            if (!todoRef) {
                document.getElementById('loadingMessage').textContent = "Not authorized to load list.";
                return;
            }
            
            const q = query(todoRef); 

            onSnapshot(q, (snapshot) => {
                const tasks = [];
                snapshot.forEach((doc) => {
                    tasks.push({ id: doc.id, ...doc.data() });
                });

                tasks.sort((a, b) => b.createdAt - a.createdAt);
                
                renderTasks(tasks);
            }, (error) => {
                console.error("Error listening to collection: ", error);
                document.getElementById('loadingMessage').textContent = "Error loading tasks. Check security rules and connection.";
            });
        }

        /**
         * Renders the list of tasks to the DOM.
         */
        function renderTasks(tasks) {
            const taskListEl = document.getElementById('taskList');
            taskListEl.innerHTML = ''; 

            if (tasks.length === 0) {
                taskListEl.innerHTML = `<p class="text-gray-500 text-center py-4">You're all done! Add a new task above.</p>`;
                return;
            }

            tasks.forEach(task => {
                const isCompleted = task.completed;
                
                const taskItem = document.createElement('div');
                taskItem.id = `task-${task.id}`;
                
                const statusClass = isCompleted ? 'completed' : 'bg-white hover:shadow-lg';
                const descriptionClass = isCompleted ? 'text-gray-500' : 'text-gray-800';

                // Tailwind Classes for responsive, styled list items
                taskItem.className = `task-item flex items-center justify-between p-4 rounded-xl shadow-md transition-all duration-300 ${statusClass} border border-gray-200`;

                taskItem.innerHTML = `
                    <div class="flex items-center flex-grow min-w-0">
                        <!-- Checkbox -->
                        <input 
                            type="checkbox" 
                            id="check-${task.id}" 
                            ${isCompleted ? 'checked' : ''}
                            onclick="window.toggleTask('${task.id}', ${isCompleted})"
                            class="h-5 w-5 text-primary bg-gray-100 border-gray-300 rounded focus:ring-secondary cursor-pointer flex-shrink-0"
                        >
                        <!-- Task Description -->
                        <label for="check-${task.id}" class="ml-4 text-lg font-medium select-none cursor-pointer truncate ${descriptionClass}">
                            ${task.description}
                        </label>
                    </div>
                    
                    <!-- Delete Button -->
                    <button 
                        onclick="window.deleteTask('${task.id}')"
                        class="ml-4 p-2 text-gray-400 hover:text-red-600 rounded-full transition duration-150 flex-shrink-0"
                        aria-label="Delete task"
                    >
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                    </button>
                `;
                taskListEl.appendChild(taskItem);
            });
        }
    </script>
</body>
</html>
